#!/bin/bash
SCRIPT_DIR=$(dirname $0)

ENCRYPTED_DEPLOYMENT_JSON=$1
MACHINE_NAME=$2
if [ "$MACHINE_NAME" == "" ]; then
    echo "usage: $(basename $0) ENCRYPTED_DEPLOYMENT_JSON MACHINE_NAME"
    exit 1
fi

ENCRYPTED_DEPLOYMENT_JSON_FNAME=$(basename $(realpath $ENCRYPTED_DEPLOYMENT_JSON))
ENCRYPTED_DEPLOYMENT_JSON_DIR=$(dirname $(realpath $ENCRYPTED_DEPLOYMENT_JSON))
PLAIN_TEXT_FILE=$(realpath $ENCRYPTED_DEPLOYMENT_JSON_DIR/$ENCRYPTED_DEPLOYMENT_JSON_FNAME.plain)

touch $PLAIN_TEXT_FILE
chmod 600 $PLAIN_TEXT_FILE
trap 'trap - SIGINT SIGTERM EXIT ; rm -f '$PLAIN_TEXT_FILE' ; exit' SIGINT SIGTERM EXIT

$SCRIPT_DIR/encrypted-json-decrypt $ENCRYPTED_DEPLOYMENT_JSON > $PLAIN_TEXT_FILE
$SCRIPT_DIR/deploy $PLAIN_TEXT_FILE $MACHINE_NAME
